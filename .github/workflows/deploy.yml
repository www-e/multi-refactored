name: Perfect Auto-Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy_and_verify:
    name: Build, Deploy & Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Executing remote SSH commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true  # ‚úÖ FIXED: Changed from script_stop_on_error
          envs: POSTGRES_PASSWORD,DISCORD_WEBHOOK
          script: |
            # --- CONFIGURATION ---
            PROJECT_DIR="/var/www/voice_agent"
            MAX_RETRIES=12
            LOCK_FILE="/tmp/navaia_deploy.lock"
            DEPLOYMENT_SUCCESS=false
            
            # Deployment Lock
            if [ -f "$LOCK_FILE" ]; then
                echo "‚ö†Ô∏è  Another deployment is in progress. Exiting..."
                exit 1
            fi
            echo $$ > "$LOCK_FILE"
            
            # Cleanup and notification on exit
            cleanup() {
                rm -f "$LOCK_FILE"
                if [ "$DEPLOYMENT_SUCCESS" = false ]; then
                    echo "‚ùå Deployment failed!"
                    curl -X POST "$DISCORD_WEBHOOK" \
                      -H 'Content-Type: application/json' \
                      -d "{\"content\":\"‚ùå Deployment failed for Navaia!\"}" 2>/dev/null || true
                fi
            }
            trap cleanup EXIT
            
            # 0. PRE-DEPLOYMENT CLEANUP (FREE DISK SPACE)
            echo "üßπ Pre-deployment cleanup..."
            docker system prune -f --volumes 2>/dev/null || true
            docker builder prune -f 2>/dev/null || true
            
            # Check disk space
            AVAILABLE_SPACE=$(df / | tail -1 | awk '{print $4}')
            echo "üíæ Available disk space: $(df -h / | tail -1 | awk '{print $4}')"
            
            if [ "$AVAILABLE_SPACE" -lt 1048576 ]; then  # Less than 1GB
                echo "‚ö†Ô∏è  WARNING: Low disk space! Aggressive cleanup..."
                docker image prune -a -f
                docker container prune -f
            fi
            
            # 1. Navigate to Project
            cd $PROJECT_DIR
            echo "üìÅ Changed directory to $PROJECT_DIR"
            
            # 2. Store current commit for rollback
            PREVIOUS_COMMIT=$(git rev-parse HEAD)
            
            # 3. Sync Code
            echo "üì• Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            CURRENT_COMMIT=$(git rev-parse HEAD)
            
            echo "üìä Deploying: $PREVIOUS_COMMIT ‚Üí $CURRENT_COMMIT"
            
            # 4. Backup Database
            echo "üíæ Creating database backup..."
            BACKUP_FILE="backups/navaia_$(date +%Y%m%d_%H%M%S).sql"
            mkdir -p backups
            docker exec navaia_db pg_dump -U navaia navaia > "$BACKUP_FILE" 2>/dev/null || echo "‚ö†Ô∏è  Backup skipped (DB may not exist yet)"
            
            # Keep only last 3 backups (reduced from 5 to save space)
            ls -t backups/*.sql 2>/dev/null | tail -n +4 | xargs -r rm
            
            # 5. Rebuild and Restart
            echo "üèóÔ∏è Building and Starting Docker Containers..."
            
            if ! docker-compose up -d --build --remove-orphans; then
                echo "‚ùå Docker build failed! Rolling back..."
                git reset --hard $PREVIOUS_COMMIT
                docker-compose up -d
                exit 1
            fi
            
            # 6. Wait for PostgreSQL
            echo "‚è≥ Waiting for PostgreSQL..."
            for i in {1..30}; do
                if docker exec navaia_db pg_isready -U navaia > /dev/null 2>&1; then
                    echo "‚úÖ PostgreSQL is ready!"
                    break
                fi
                [ $i -eq 30 ] && { echo "‚ùå PostgreSQL failed to start!"; exit 1; }
                sleep 1
            done
            
            # 7. Smart Migration Handler
            echo "üîÑ Running Database Migrations..."
            
            DB_REVISION=$(docker exec navaia_db psql -U navaia -d navaia -t -c "SELECT version_num FROM alembic_version LIMIT 1;" 2>/dev/null | xargs)
            LATEST_REVISION=$(docker exec navaia_backend alembic heads 2>/dev/null | grep -oP '^[a-f0-9]+' | head -n1)
            
            echo "üìä Database revision: ${DB_REVISION:-none}"
            echo "üìä Latest migration: ${LATEST_REVISION:-none}"
            
            if [ -n "$DB_REVISION" ] && [ "$DB_REVISION" != "None" ]; then
                if ! docker exec navaia_backend alembic show "$DB_REVISION" > /dev/null 2>&1; then
                    echo "‚ö†Ô∏è  Database revision '$DB_REVISION' not found in migration files!"
                    echo "üîß Force clearing bad revision and stamping to: $LATEST_REVISION"
                    
                    docker exec navaia_db psql -U navaia -d navaia -c "DELETE FROM alembic_version WHERE version_num = '$DB_REVISION';" > /dev/null 2>&1
                    
                    if ! docker exec navaia_backend alembic stamp head; then
                        echo "‚ùå Failed to stamp database!"
                        docker logs navaia_backend --tail 50
                        exit 1
                    fi
                    echo "‚úÖ Database stamped successfully!"
                fi
            fi
            
            if ! docker exec navaia_backend alembic upgrade head; then
                echo "‚ùå Migration Failed!"
                docker logs navaia_backend --tail 50
                
                if [ -f "$BACKUP_FILE" ]; then
                    echo "üîÑ Restoring from backup..."
                    docker exec -i navaia_db psql -U navaia navaia < "$BACKUP_FILE"
                fi
                
                git reset --hard $PREVIOUS_COMMIT
                docker-compose up -d --build
                exit 1
            fi
            
            echo "‚úÖ Migrations completed successfully!"
            
            # 8. POST-DEPLOYMENT CLEANUP
            echo "üßπ Post-deployment cleanup..."
            docker image prune -f
            docker builder prune -f
            
            # 9. Health Check Function
            check_health() {
                local url=$1
                local name=$2
                local retries=0
                
                echo "üè• Checking $name at $url..."
                
                until curl -f -s -o /dev/null "$url"; do
                    retries=$((retries+1))
                    if [ $retries -gt $MAX_RETRIES ]; then
                        echo "‚ùå $name failed to start after $((MAX_RETRIES*5)) seconds."
                        return 1
                    fi
                    echo "‚è≥ $name not ready yet... waiting 5s ($retries/$MAX_RETRIES)"
                    sleep 5
                done
                echo "‚úÖ $name is HEALTHY!"
                return 0
            }
            
            # 10. Execute Health Checks
            if ! check_health "http://127.0.0.1:8000/healthz" "Backend"; then
                echo "üîç DUMPING BACKEND LOGS:"
                docker logs navaia_backend --tail 50
                exit 1
            fi
            
            if ! check_health "http://127.0.0.1:3001" "Frontend"; then
                echo "üîç DUMPING FRONTEND LOGS:"
                docker logs navaia_frontend --tail 50
                exit 1
            fi
            
            # 11. Success!
            DEPLOYMENT_SUCCESS=true
            echo "üöÄ Deployment Complete & Verified Successfully!"
            echo "üì¶ Backup saved: $BACKUP_FILE"
            echo "üìä Commit: $CURRENT_COMMIT"
            echo "üíæ Disk space: $(df -h / | tail -1 | awk '{print $4}') available"
            
            curl -X POST "$DISCORD_WEBHOOK" \
              -H 'Content-Type: application/json' \
              -d "{\"content\":\"‚úÖ Navaia deployed successfully! (\`${CURRENT_COMMIT:0:7}\`)\"}" 2>/dev/null || true
        env:
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
