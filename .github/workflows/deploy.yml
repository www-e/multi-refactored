name: Perfect Auto-Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy_and_verify:
    name: Build, Deploy & Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Executing remote SSH commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop_on_error: true
          script: |
            # --- CONFIGURATION ---
            PROJECT_DIR="/var/www/voice_agent"
            MAX_RETRIES=12   # 12 * 5 seconds = 60 seconds max wait
            
            # 1. Navigate to Project
            cd $PROJECT_DIR
            echo "ğŸ“ Changed directory to $PROJECT_DIR"
            
            # 2. Sync Code
            echo "ğŸ“¥ Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            
            # 3. Backup Database (Safety Net)
            echo "ğŸ’¾ Creating database backup..."
            BACKUP_FILE="backups/navaia_$(date +%Y%m%d_%H%M%S).sql"
            mkdir -p backups
            docker exec navaia_db pg_dump -U navaia navaia > "$BACKUP_FILE" 2>/dev/null || echo "âš ï¸  Backup skipped (DB may not exist yet)"
            
            # Keep only last 5 backups
            ls -t backups/*.sql 2>/dev/null | tail -n +6 | xargs -r rm
            
            # 4. Rebuild and Restart
            echo "ğŸ—ï¸ Building and Starting Docker Containers..."
            docker-compose up -d --build --remove-orphans
            
            # 5. Wait for PostgreSQL to be ready
            echo "â³ Waiting for PostgreSQL..."
            for i in {1..30}; do
                if docker exec navaia_db pg_isready -U navaia > /dev/null 2>&1; then
                    echo "âœ… PostgreSQL is ready!"
                    break
                fi
                sleep 1
            done
            
            # 6. Smart Migration Handler
            echo "ğŸ”„ Running Database Migrations..."
            
            # Get current database revision
            DB_REVISION=$(docker exec navaia_db psql -U navaia -d navaia -t -c "SELECT version_num FROM alembic_version LIMIT 1;" 2>/dev/null | xargs)
            
            # Get latest migration file revision
            LATEST_REVISION=$(docker exec navaia_backend alembic heads 2>/dev/null | grep -oP '^[a-f0-9]+' | head -n1)
            
            echo "ğŸ“Š Database revision: ${DB_REVISION:-none}"
            echo "ğŸ“Š Latest migration: ${LATEST_REVISION:-none}"
            
            # Check if database revision exists in migration files
            if [ -n "$DB_REVISION" ] && [ "$DB_REVISION" != "None" ]; then
                if ! docker exec navaia_backend alembic show "$DB_REVISION" > /dev/null 2>&1; then
                    echo "âš ï¸  Database revision '$DB_REVISION' not found in migration files!"
                    echo "ğŸ”§ Stamping database to latest revision: $LATEST_REVISION"
                    
                    # Stamp to head (sync database state with code)
                    if ! docker exec navaia_backend alembic stamp head; then
                        echo "âŒ Failed to stamp database!"
                        docker logs navaia_backend --tail 50
                        exit 1
                    fi
                    echo "âœ… Database stamped successfully!"
                fi
            fi
            
            # Run migrations
            if ! docker exec navaia_backend alembic upgrade head; then
                echo "âŒ Migration Failed!"
                echo "ğŸ” Backend logs:"
                docker logs navaia_backend --tail 50
                
                # Restore from backup if available
                if [ -f "$BACKUP_FILE" ]; then
                    echo "ğŸ”„ Restoring from backup..."
                    docker exec -i navaia_db psql -U navaia navaia < "$BACKUP_FILE"
                    echo "âœ… Database restored from backup!"
                fi
                exit 1
            fi
            
            echo "âœ… Migrations completed successfully!"
            
            # 7. Cleanup Disk Space
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # 8. Smart Health Check Function
            check_health() {
                local url=$1
                local name=$2
                local retries=0
                
                echo "ğŸ¥ Checking $name at $url..."
                
                until curl -f -s -o /dev/null "$url"; do
                    retries=$((retries+1))
                    if [ $retries -gt $MAX_RETRIES ]; then
                        echo "âŒ $name failed to start after $((MAX_RETRIES*5)) seconds."
                        return 1
                    fi
                    echo "â³ $name not ready yet... waiting 5s ($retries/$MAX_RETRIES)"
                    sleep 5
                done
                echo "âœ… $name is HEALTHY!"
                return 0
            }
            
            # 9. Execute Health Checks
            if ! check_health "http://127.0.0.1:8000/healthz" "Backend"; then
                echo "ğŸ” DUMPING BACKEND LOGS:"
                docker logs navaia_backend --tail 50
                exit 1
            fi
            
            if ! check_health "http://127.0.0.1:3001" "Frontend"; then
                echo "ğŸ” DUMPING FRONTEND LOGS:"
                docker logs navaia_frontend --tail 50
                exit 1
            fi
            
            echo "ğŸš€ Deployment Complete & Verified Successfully!"
            echo "ğŸ“¦ Backup saved: $BACKUP_FILE"
