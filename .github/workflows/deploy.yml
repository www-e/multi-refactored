name: Perfect Auto-Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  deploy_and_verify:
    name: Build, Deploy & Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Executing remote SSH commands
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop_on_error: true
          script: |
            # --- CONFIGURATION ---
            PROJECT_DIR="/var/www/voice_agent"
            MAX_RETRIES=12   # 12 * 5 seconds = 60 seconds max wait
            
            # 1. Navigate to Project
            cd $PROJECT_DIR
            echo "üìÅ Changed directory to $PROJECT_DIR"
            
            # 2. Sync Code
            echo "üì• Pulling latest code..."
            git fetch --all
            git reset --hard origin/main
            
            # 3. Rebuild and Restart (Zero-downtime attempt via --build)
            echo "üèóÔ∏è Building and Starting Docker Containers..."
            docker-compose up -d --build --remove-orphans
            
            # 4. Smart Health Check Function
            check_health() {
                local url=$1
                local name=$2
                local retries=0
                
                echo "üè• Checking $name at $url..."
                
                until curl -f -s -o /dev/null "$url"; do
                    retries=$((retries+1))
                    if [ $retries -gt $MAX_RETRIES ]; then
                        echo "‚ùå $name failed to start after $((MAX_RETRIES*5)) seconds."
                        return 1
                    fi
                    echo "‚è≥ $name not ready yet... waiting 5s ($retries/$MAX_RETRIES)"
                    sleep 5
                done
                echo "‚úÖ $name is HEALTHY!"
                return 0
            }

            # 5. Run Database Migrations 
            # We wait 5 seconds first to let Postgres container initialize
            sleep 5 
            echo "üîÑ Running Database Migrations..."
            if ! docker exec navaia_backend alembic upgrade head; then
                echo "‚ùå Migration Failed!"
                docker logs navaia_backend --tail 50
                exit 1
            fi

            # 6. Cleanup Disk Space (Keep server clean)
            echo "üßπ Cleaning up old images..."
            docker image prune -f
            
            # 7. Execute Health Checks
            # Check Backend (Port 8000)
            if ! check_health "http://127.0.0.1:8000/healthz" "Backend"; then
                echo "üîç DUMPING BACKEND LOGS:"
                docker logs navaia_backend --tail 50
                exit 1
            fi

            # Check Frontend (Port 3001)
            if ! check_health "http://127.0.0.1:3001" "Frontend"; then
                echo "üîç DUMPING FRONTEND LOGS:"
                docker logs navaia_frontend --tail 50
                exit 1
            fi

            echo "üöÄ Deployment Complete & Verified Successfully!"